#! /bin/bash
IFS=$'\n'

while [ -n "$1" ]
do
case $1 in 

    "--help"|"-h")
        echo "This restores files from /home/$USER/.trash based on data in ~/.trash/dataDir/goopData"
        echo ---------------------------------------------------------------------------------------
        echo -e "--help or -h \t \t   summons help"
        echo -e "--deleted or -d \t   to show all contents of the bin with full paths"
        echo -e "--deleted-local or -l  \t   to show all files in the bin that were deleted from currend directory"
        echo -e "--undo or -u TIME \t   undo all deletions during the last TIME minutes"
        echo -e "--clear or -c FILE.. \t   to remove files from the bin"
        echo -e "--move-here or -m FILE..   to restore files to the current directory"
        echo -e "FILE \t                   to undo deletion of the FILE. It will be returned to the directory it was deleted from"
        echo ---------------------------------------------------------------------------------------
        shift
    ;;

    "--deleted"|"-d")
        cat /home/$USER/.trash/dataDir/goopData
        shift
    ;;

    "--local-deleted"|"-l")
        pat=$(eval "realpath ./")
        papat="$pat/"
        mas=$(eval "grep "$pat" /home/$USER/.trash/dataDir/goopData")
        for str in $mas
        do 
            echo ${str##$papat}
        done 
        shift
    ;;

    "--undo"|"-u")
        cd /home/$USER/.trash
        shift
        secs=$(($1*60))
        for file in $(ls -p1 | grep -v /)
        do
            if [ $(($(eval "date +%s") - $(eval "stat \"$file\" -c %Z"))) -le $secs ]
            then 
                file=$(eval echo "$1" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')
                doublefile="$(eval echo \"$file\" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')"
                greppath=$(grep -m 1 $doublefile ./dataDir/goopData)
                actualpath=$(eval echo \"$greppath\" | sed 's|\\\\|\\|g')
                eval "mv -T $file $actualpath"
                if ! [ -e "$1" ]
                then
                    echo "Restored $actualpath"
                    sed -i "/$doublefile/d" ./dataDir/goopData
                fi
            fi 
        done 
        shift
    ;;

    "-c"|"--clear")
        shift
        while [ -n "$1" ]
        do
            cd /home/$USER/.trash 
            file=$(eval echo "$1" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')
            doublefile="$(eval echo \"$file\" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')"
            rm ./$file
            sed -i "/$doublefile/d" ./dataDir/goopData
            echo "$file deleted forever"
            shift
        done
    ;;        

    "-m"|"--move-here")
        shift
        pat=$(eval "realpath ./")
        while [ -n "$1" ]
        do
            eval "mv /home/$USER/.trash/$1 $pat"
            if ! [ -e "/home/$USER/.trash/$1" ]
            then
                echo "Restored $1 to this directory"
                sed -i "/$1/d" /home/$USER/.trash/dataDir/goopData
            fi
            shift
        done
        ;;

    *)
        cd /home/$USER/.trash
        file=$(eval echo "$1" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')
        doublefile="$(eval echo \"$file\" | sed 's|[ \!?)([<>%$*-,;=^`|.:]|\\&|g')"
        greppath=$(grep -m 1 $doublefile ./dataDir/goopData)
        if [ -n "$greppath" ]
        then
            actualpath=$(eval echo \"$greppath\" | sed 's|\\\\|\\|g')
            eval "mv -T $file $actualpath"
            if ! [ -e "$1" ]
            then
                echo "Restored $actualpath"
                sed -i "/$doublefile/d" ./dataDir/goopData
            fi
        else 
            echo "$file is not in the bin"
        fi
        shift
    ;;

esac

done

