#! /bin/sh

while [ -n "$1" ]
do
case $1 in 

    "--help"|"-h")
        echo This restores files from /home/\$USER/.trash based on data in ~/.trash/dataDir/goopData
        echo ---------------------------------------------------------------------------------------
        echo "--help or -h \t \t   summons help"
        echo "--deleted or -d \t   to show all contents of the bin with full paths"
        echo "--deleted-local or -l  \t   to show all files in the bin that were deleted from currend directory"
        echo "--undo or -u TIME \t   undo all deletions during the last TIME minutes"
        echo "--clear or -c FILE.. \t   to remove files from the bin"
        echo "--move-here or -m FILE..   to restore files to the current directory"
        echo "FILE \t                   to undo deletion of the FILE. It will be returned to the directory it was deleted from"
        echo ---------------------------------------------------------------------------------------
        shift
    ;;

    "--deleted"|"-d")
        cat /home/$USER/.trash/dataDir/goopData
        shift
    ;;

    "--local-deleted"|"-l")
        pat=$(eval "realpath ./")
        slashpat="$pat/"
        for str in $(eval "grep "$pat" /home/$USER/.trash/dataDir/goopData") 
        do 
            filepat=${str##$slashpat}
            if [ -z "$(eval echo $filepat |  grep "/" )" ]
            then 
                echo $filepat
            fi
        done 
        shift
    ;;

    "--undo"|"-u")
        cd /home/$USER/.trash
        shift
        secs=$(($1*60))
        for file in $(ls -p1 | grep -v /)
        do
            if [ $(($(eval "date +%s") - $(eval "stat $file -c %Z"))) -le $secs ]
            then 
                eval "mv -T $file \$(grep $file ./dataDir/goopData)"
                if ! [ -e "$file" ]
                then
                    sed -i "/$file/d" ./dataDir/goopData
                    echo "Restored $(eval "grep $file ./dataDir/goopData")"
                fi
            fi 
        done 
        shift
    ;;

    "-c"|"--clear")
        shift
        while [ -n "$1" ]
        do
            cd /home/$USER/.trash 
            rm ./$1
            sed -i "/$1/d" ./dataDir/goopData
            shift
        done
    ;;        

    "-m"|"--move-here")
        shift
        pat=$(eval "realpath ./")
        while [ -n "$1" ]
        do
            eval "mv /home/$USER/.trash/$1 $pat"
            if ! [ -e "/home/$USER/.trash/$1" ]
            then
                sed -i "/$1/d" /home/$USER/.trash/dataDir/goopData
                echo "Restored $1 to this directory"
            fi
            shift
        done
        ;;

    *)
        cd /home/$USER/.trash
        eval "mv -T $1 \$(grep -m 1 $1 ./dataDir/goopData)"
        if ! [ -e "$1" ]
        then
            echo "Restored $(eval "grep $1 ./dataDir/goopData")"
            sed -i "/$1/d" ./dataDir/goopData
        fi
        shift
    ;;

esac

done

